<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mini Project Hub</title>
  <style>
    :root {
      color-scheme: light;
      --bg: #f5f6fb;
      --surface: #ffffff;
      --surface-muted: #f0f2f8;
      --border: #d7dbe8;
      --accent: #3a60ff;
      --accent-soft: rgba(58, 96, 255, 0.12);
      --accent-strong: rgba(58, 96, 255, 0.18);
      --text: #1f2430;
      --muted: #6c7285;
      --danger: #ff5a6a;
      --success: #1f9d64;
      --shadow: 0 20px 40px rgba(31, 36, 48, 0.08);
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      background: radial-gradient(circle at 20% 20%, rgba(58, 96, 255, 0.12), transparent 45%),
        radial-gradient(circle at 80% 0%, rgba(31, 157, 100, 0.1), transparent 45%), var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      padding: 2.75rem clamp(1.5rem, 5vw, 4rem) 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      background: linear-gradient(145deg, rgba(255, 255, 255, 0.8), rgba(255, 255, 255, 0.6));
      backdrop-filter: blur(14px);
      border-bottom: 1px solid var(--border);
      box-shadow: 0 24px 60px rgba(31, 36, 48, 0.08);
    }

    header h1 {
      margin: 0;
      font-size: clamp(2.2rem, 3vw + 1rem, 3.2rem);
      letter-spacing: 0.03em;
    }

    header p {
      margin: 0;
      max-width: 60ch;
      color: var(--muted);
      font-size: 1.05rem;
      line-height: 1.6;
    }

    .toolbar {
      display: grid;
      gap: 1.25rem;
      align-items: start;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    }

    .task-form,
    .global-actions {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 1.25rem;
      padding: 1.25rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: center;
      box-shadow: var(--shadow);
    }

    .task-form label,
    .global-actions label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
      display: block;
    }

    .form-field {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
      min-width: 160px;
      flex: 1 1 150px;
    }

    input[type="text"],
    input[type="date"],
    select {
      background: var(--surface-muted);
      border: 1px solid var(--border);
      border-radius: 0.85rem;
      padding: 0.65rem 0.9rem;
      color: var(--text);
      font: inherit;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    input[type="text"]:focus,
    input[type="date"]:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 4px var(--accent-soft);
    }

    button {
      background: var(--accent);
      color: #fff;
      border: 1px solid transparent;
      border-radius: 0.85rem;
      padding: 0.65rem 1.2rem;
      font-weight: 600;
      letter-spacing: 0.02em;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.2s ease, filter 0.2s ease;
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 16px 30px rgba(58, 96, 255, 0.2);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    button.secondary {
      background: var(--surface-muted);
      color: var(--text);
      border-color: var(--border);
      box-shadow: none;
    }

    button.secondary:hover {
      box-shadow: 0 10px 20px rgba(31, 36, 48, 0.1);
    }

    main {
      flex: 1;
      display: grid;
      gap: 2rem;
      padding: 2.5rem clamp(1.5rem, 5vw, 4rem) 3rem;
      grid-template-columns: 1fr;
    }

    .workspace {
      display: grid;
      gap: 2rem;
      grid-template-columns: minmax(0, 3fr) minmax(0, 1fr);
      align-items: start;
    }

    .board {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 1.5rem;
    }

    .column {
      background: var(--surface);
      border-radius: 1.25rem;
      padding: 1.25rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      min-height: 60vh;
      transition: border-color 0.2s ease, background 0.2s ease;
    }

    .column.drag-over {
      border-color: var(--accent);
      background: rgba(58, 96, 255, 0.08);
    }

    .column h2 {
      margin: 0;
      font-size: 1.05rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .column-body {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      flex: 1;
    }

    .empty-state {
      text-align: center;
      margin-top: 2.5rem;
      color: var(--muted);
      font-size: 0.95rem;
    }

    .task-card {
      background: var(--surface-muted);
      border-radius: 1rem;
      padding: 1rem 1.1rem;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      border: 1px solid var(--border);
      box-shadow: 0 16px 28px rgba(31, 36, 48, 0.08);
      transition: transform 0.15s ease, box-shadow 0.2s ease, border-color 0.2s ease;
    }

    .task-card.dragging {
      opacity: 0.7;
      transform: scale(1.01);
      box-shadow: 0 16px 32px rgba(31, 36, 48, 0.14);
    }

    .card-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.75rem;
    }

    .project-label {
      background: rgba(31, 157, 100, 0.12);
      color: var(--success);
      padding: 0.35rem 0.7rem;
      border-radius: 999px;
      font-size: 0.75rem;
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }

    .importance-badge {
      padding: 0.35rem 0.7rem;
      border-radius: 999px;
      font-size: 0.75rem;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      font-weight: 600;
    }

    .importance-alta {
      background: rgba(255, 90, 106, 0.14);
      color: var(--danger);
    }

    .importance-media {
      background: rgba(58, 96, 255, 0.12);
      color: var(--accent);
    }

    .importance-baja {
      background: rgba(31, 157, 100, 0.12);
      color: var(--success);
    }

    .task-title {
      margin: 0;
      font-size: 1.1rem;
      line-height: 1.4;
    }

    .tags {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
    }

    .tag {
      background: var(--accent-soft);
      color: var(--accent);
      padding: 0.25rem 0.6rem;
      border-radius: 999px;
      font-size: 0.75rem;
      letter-spacing: 0.04em;
    }

    textarea {
      resize: vertical;
      min-height: 4.75rem;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 0.85rem;
      padding: 0.75rem;
      color: var(--text);
      font-family: inherit;
      line-height: 1.5;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .card-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
      font-size: 0.8rem;
      color: var(--muted);
    }

    .date-group {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .card-actions {
      display: flex;
      gap: 0.4rem;
    }

    .card-actions button {
      background: var(--surface);
      color: var(--text);
      border: 1px solid var(--border);
      padding: 0.35rem 0.65rem;
      border-radius: 0.65rem;
      font-size: 0.9rem;
      min-width: 2.2rem;
    }

    .card-actions button:hover {
      border-color: var(--accent);
      color: var(--accent);
      box-shadow: 0 6px 16px rgba(58, 96, 255, 0.18);
    }

    aside {
      background: var(--surface);
      border-radius: 1.25rem;
      border: 1px solid var(--border);
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      position: sticky;
      top: 2rem;
      box-shadow: var(--shadow);
    }

    aside h2 {
      margin: 0;
      font-size: 1.3rem;
    }

    .muted {
      color: var(--muted);
      font-size: 0.95rem;
      line-height: 1.6;
    }

    .pomodoro-display {
      font-size: clamp(2.4rem, 3vw + 1rem, 3.1rem);
      letter-spacing: 0.18em;
      text-align: center;
      margin: 1.25rem 0 0.75rem;
      font-weight: 600;
    }

    .pomodoro-controls {
      display: flex;
      gap: 0.75rem;
      justify-content: center;
    }

    .pomodoro-controls button {
      flex: 1;
      font-size: 0.95rem;
      letter-spacing: 0.08em;
    }

    @media (max-width: 1100px) {
      .workspace {
        grid-template-columns: 1fr;
      }

      aside {
        position: static;
      }
    }

    @media (max-width: 900px) {
      .board {
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      }
    }

    @media (max-width: 720px) {
      header {
        padding-bottom: 2rem;
      }

      .task-form,
      .global-actions {
        flex-direction: column;
        align-items: stretch;
      }

      .form-field,
      .task-form button,
      .global-actions button {
        width: 100%;
      }

      .card-actions {
        width: 100%;
        justify-content: space-between;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Mini Project Hub</h1>
    <p>Centraliza iniciativas por proyecto, planifica con claridad y mant√©n el ritmo con el Pomodoro integrado en una vista minimista.</p>
    <div class="toolbar">
      <form id="task-form" class="task-form">
        <div class="form-field">
          <label for="task-project">Proyecto</label>
          <input id="task-project" type="text" placeholder="Nombre del proyecto" required />
        </div>
        <div class="form-field">
          <label for="task-title">T√≠tulo</label>
          <input id="task-title" type="text" placeholder="Descripci√≥n breve" required />
        </div>
        <div class="form-field">
          <label for="task-tags">Tags</label>
          <input id="task-tags" type="text" placeholder="Dise√±o, UX, Investigaci√≥n" />
        </div>
        <div class="form-field">
          <label for="task-importance">Importancia</label>
          <select id="task-importance">
            <option value="Alta">Alta</option>
            <option value="Media" selected>Media</option>
            <option value="Baja">Baja</option>
          </select>
        </div>
        <div class="form-field">
          <label for="task-deadline">Fecha l√≠mite</label>
          <input id="task-deadline" type="date" />
        </div>
        <button type="submit">A√±adir tarea</button>
      </form>
      <div class="global-actions">
        <div class="form-field">
          <label for="project-filter">Filtrar por proyecto</label>
          <select id="project-filter">
            <option value="all">Todos</option>
          </select>
        </div>
        <div class="form-field">
          <label for="date-filter">Filtrar por fecha l√≠mite</label>
          <input id="date-filter" type="date" />
        </div>
        <div class="action-buttons" style="display: flex; flex-wrap: wrap; gap: 0.6rem;">
          <button id="export-csv" type="button" class="secondary">Exportar CSV</button>
          <button id="import-csv" type="button" class="secondary">Importar CSV</button>
          <button id="clear-all" type="button" class="secondary">Borrar todo</button>
        </div>
        <input id="csv-file" type="file" accept=".csv" hidden />
      </div>
    </div>
  </header>
  <main>
    <div class="workspace">
      <section class="board" aria-label="Tablero Kanban">
        <div class="column" data-state="todo">
          <h2>Por hacer</h2>
          <div class="column-body"></div>
        </div>
        <div class="column" data-state="doing">
          <h2>En curso</h2>
          <div class="column-body"></div>
        </div>
        <div class="column" data-state="done">
          <h2>Hecho</h2>
          <div class="column-body"></div>
        </div>
      </section>
      <aside>
        <h2>Pomodoro</h2>
        <p class="muted">Ritmo cl√°sico de 25 minutos. Controla el temporizador en paralelo al tablero.</p>
        <div class="pomodoro-display" id="pomodoro-display">25:00</div>
        <div class="pomodoro-controls">
          <button id="pomodoro-start" type="button">PLAY</button>
          <button id="pomodoro-pause" type="button">PAUSE</button>
          <button id="pomodoro-reset" type="button">RESTART</button>
        </div>
      </aside>
    </div>
  </main>

  <template id="task-template">
    <article class="task-card" draggable="true">
      <div class="card-top">
        <span class="project-label"></span>
        <span class="importance-badge"></span>
      </div>
      <h3 class="task-title"></h3>
      <div class="tags"></div>
      <textarea class="task-note" placeholder="Notas r√°pidas..."></textarea>
      <div class="card-footer">
        <div class="date-group">
          <span class="created"></span>
          <span class="deadline"></span>
        </div>
        <div class="card-actions">
          <button class="move-left" type="button" title="Mover a la columna anterior">‚Üê</button>
          <button class="move-right" type="button" title="Mover a la columna siguiente">‚Üí</button>
          <button class="delete" type="button" title="Eliminar">üóë</button>
        </div>
      </div>
    </article>
  </template>

  <script>
    const STORAGE_KEY = 'mini-project-hub-state-v2';
    const LEGACY_KEYS = ['mini-project-hub-state-v1'];
    const columnOrder = ['todo', 'doing', 'done'];

    let tasks = [];
    const filters = { project: 'all', date: '' };

    const boardColumns = Array.from(document.querySelectorAll('.column'));
    const form = document.getElementById('task-form');
    const projectInput = document.getElementById('task-project');
    const titleInput = document.getElementById('task-title');
    const tagsInput = document.getElementById('task-tags');
    const importanceInput = document.getElementById('task-importance');
    const deadlineInput = document.getElementById('task-deadline');
    const exportBtn = document.getElementById('export-csv');
    const importBtn = document.getElementById('import-csv');
    const clearBtn = document.getElementById('clear-all');
    const fileInput = document.getElementById('csv-file');
    const projectFilter = document.getElementById('project-filter');
    const dateFilter = document.getElementById('date-filter');

    function normalizeTask(raw) {
      return {
        id: raw.id ?? crypto.randomUUID(),
        title: (raw.title ?? '').trim() || 'Sin t√≠tulo',
        tags: Array.isArray(raw.tags)
          ? raw.tags.filter(Boolean)
          : String(raw.tags ?? '')
              .split(',')
              .map((tag) => tag.trim())
              .filter(Boolean),
        note: raw.note ?? '',
        state: columnOrder.includes(raw.state) ? raw.state : 'todo',
        created: raw.created ?? new Date().toISOString(),
        project: (raw.project ?? '').trim() || 'General',
        importance: ['Alta', 'Media', 'Baja'].includes(raw.importance) ? raw.importance : 'Media',
        dueDate: typeof raw.dueDate === 'string' ? raw.dueDate.trim() : raw.dueDate ?? '',
      };
    }

    function loadState() {
      try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
          const parsed = JSON.parse(saved);
          if (Array.isArray(parsed)) {
            tasks = parsed.map(normalizeTask);
            return;
          }
        }
        for (const key of LEGACY_KEYS) {
          const legacy = localStorage.getItem(key);
          if (legacy) {
            const parsedLegacy = JSON.parse(legacy);
            if (Array.isArray(parsedLegacy)) {
              tasks = parsedLegacy.map(normalizeTask);
              saveState();
              return;
            }
          }
        }
      } catch (error) {
        console.error('Error al cargar estado', error);
      }
    }

    function saveState() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(tasks));
    }

    function createTask({ project, title, tags, importance, dueDate }) {
      const now = new Date();
      const task = normalizeTask({
        id: crypto.randomUUID(),
        title,
        tags,
        note: '',
        state: 'todo',
        created: now.toISOString(),
        project,
        importance,
        dueDate,
      });
      tasks.push(task);
      saveState();
      renderProjectFilterOptions();
      renderBoard();
    }

    function toComparableDate(value) {
      if (!value) return null;
      const dateString = typeof value === 'string' ? value : '';
      const [datePart] = dateString.split('T');
      if (!datePart) return null;
      const [year, month, day] = datePart.split('-').map((part) => Number.parseInt(part, 10));
      if ([year, month, day].some((num) => Number.isNaN(num))) {
        return null;
      }
      const date = new Date(year, month - 1, day);
      if (Number.isNaN(date.getTime())) return null;
      date.setHours(0, 0, 0, 0);
      return date.getTime();
    }

    function formatDateTime(isoString) {
      if (!isoString) return '';
      const date = new Date(isoString);
      if (Number.isNaN(date.getTime())) return '';
      return `Creada: ${date.toLocaleString()}`;
    }

    function formatDeadline(dateString) {
      const comparable = toComparableDate(dateString);
      if (comparable === null) return 'Sin fecha l√≠mite';
      const date = new Date(comparable);
      return `Fecha l√≠mite: ${date.toLocaleDateString()}`;
    }

    function updateEmptyStates() {
      boardColumns.forEach((column) => {
        const body = column.querySelector('.column-body');
        const hasTasks = body.querySelector('.task-card');
        let empty = body.querySelector('.empty-state');
        if (!hasTasks) {
          if (!empty) {
            empty = document.createElement('p');
            empty.className = 'empty-state';
            empty.textContent = 'Sin tareas visibles en esta columna.';
            body.appendChild(empty);
          }
        } else if (empty) {
          empty.remove();
        }
      });
    }

    function matchesFilters(task) {
      const projectMatch = filters.project === 'all' || task.project === filters.project;
      if (!projectMatch) return false;

      if (!filters.date) return true;
      const taskComparable = toComparableDate(task.dueDate);
      const filterComparable = toComparableDate(filters.date);
      if (taskComparable === null || filterComparable === null) return false;
      return taskComparable <= filterComparable;
    }

    function renderBoard() {
      const bodies = document.querySelectorAll('.column-body');
      bodies.forEach((body) => {
        body.innerHTML = '';
      });

      tasks.forEach((task) => {
        if (!matchesFilters(task)) return;
        const column = document.querySelector(`.column[data-state="${task.state}"] .column-body`);
        if (!column) return;
        const card = buildTaskCard(task);
        column.appendChild(card);
      });

      updateEmptyStates();
    }

    function buildTaskCard(task) {
      const template = document.getElementById('task-template');
      const fragment = template.content.cloneNode(true);
      const card = fragment.querySelector('.task-card');
      const projectLabel = fragment.querySelector('.project-label');
      const importanceBadge = fragment.querySelector('.importance-badge');
      const titleEl = fragment.querySelector('.task-title');
      const tagsContainer = fragment.querySelector('.tags');
      const noteArea = fragment.querySelector('.task-note');
      const createdEl = fragment.querySelector('.created');
      const deadlineEl = fragment.querySelector('.deadline');
      const leftBtn = fragment.querySelector('.move-left');
      const rightBtn = fragment.querySelector('.move-right');
      const deleteBtn = fragment.querySelector('.delete');

      card.dataset.id = task.id;
      projectLabel.textContent = task.project;
      importanceBadge.textContent = task.importance;
      importanceBadge.className = `importance-badge importance-${task.importance.toLowerCase()}`;
      titleEl.textContent = task.title;
      noteArea.value = task.note || '';
      createdEl.textContent = formatDateTime(task.created);
      deadlineEl.textContent = formatDeadline(task.dueDate);

      tagsContainer.innerHTML = '';
      if (task.tags.length) {
        task.tags.forEach((tag) => {
          const badge = document.createElement('span');
          badge.className = 'tag';
          badge.textContent = tag;
          tagsContainer.appendChild(badge);
        });
      }

      const currentIndex = columnOrder.indexOf(task.state);
      if (currentIndex <= 0) {
        leftBtn.disabled = true;
      }
      if (currentIndex === columnOrder.length - 1) {
        rightBtn.disabled = true;
      }

      leftBtn.addEventListener('click', () => moveTask(task.id, -1));
      rightBtn.addEventListener('click', () => moveTask(task.id, 1));
      deleteBtn.addEventListener('click', () => deleteTask(task.id));

      noteArea.addEventListener('input', (event) => {
        updateTaskNote(task.id, event.target.value);
      });

      card.addEventListener('dragstart', (event) => {
        card.classList.add('dragging');
        event.dataTransfer.effectAllowed = 'move';
        event.dataTransfer.setData('text/plain', task.id);
      });

      card.addEventListener('dragend', () => {
        card.classList.remove('dragging');
      });

      return card;
    }

    function moveTask(id, direction) {
      const index = tasks.findIndex((task) => task.id === id);
      if (index === -1) return;
      const currentState = tasks[index].state;
      const position = columnOrder.indexOf(currentState);
      const nextPosition = position + direction;
      if (nextPosition < 0 || nextPosition >= columnOrder.length) return;
      tasks[index].state = columnOrder[nextPosition];
      saveState();
      renderBoard();
    }

    function deleteTask(id) {
      tasks = tasks.filter((task) => task.id !== id);
      saveState();
      renderProjectFilterOptions();
      renderBoard();
    }

    function updateTaskNote(id, note) {
      const task = tasks.find((item) => item.id === id);
      if (!task) return;
      task.note = note;
      saveState();
    }

    form.addEventListener('submit', (event) => {
      event.preventDefault();
      const project = projectInput.value.trim();
      const title = titleInput.value.trim();
      const tags = tagsInput.value
        .split(',')
        .map((tag) => tag.trim())
        .filter((tag) => tag.length);
      const importance = importanceInput.value;
      const dueDate = deadlineInput.value ? deadlineInput.value : '';

      if (!project || !title) return;

      createTask({ project, title, tags, importance, dueDate });

      projectInput.value = '';
      titleInput.value = '';
      tagsInput.value = '';
      importanceInput.value = 'Media';
      deadlineInput.value = '';
      projectInput.focus();
    });

    function escapeCsvValue(value) {
      const stringValue = String(value ?? '');
      const escaped = stringValue.replace(/"/g, '""');
      return `"${escaped}"`;
    }

    function downloadCsv() {
      const header = ['id', 'title', 'tags', 'note', 'state', 'created', 'end date', 'project', 'importance'];
      const rows = tasks.map((task) => [
        task.id,
        task.title,
        task.tags.join('|'),
        task.note,
        task.state,
        task.created,
        task.dueDate ?? '',
        task.project,
        task.importance,
      ]);
      const csv = [header, ...rows]
        .map((row) => row.map(escapeCsvValue).join(','))
        .join('\n');

      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      const timestamp = new Date().toISOString().split('T')[0];
      link.href = url;
      link.download = `mini-project-hub-${timestamp}.csv`;
      document.body.appendChild(link);
      link.click();
      link.remove();
      URL.revokeObjectURL(url);
    }

    function parseCsv(text) {
      const rows = [];
      let current = [];
      let value = '';
      let inQuotes = false;

      for (let i = 0; i < text.length; i++) {
        const char = text[i];

        if (char === '"') {
          if (inQuotes && text[i + 1] === '"') {
            value += '"';
            i++;
          } else {
            inQuotes = !inQuotes;
          }
        } else if (char === ',' && !inQuotes) {
          current.push(value);
          value = '';
        } else if ((char === '\n' || char === '\r') && !inQuotes) {
          if (char === '\r' && text[i + 1] === '\n') {
            i++;
          }
          current.push(value);
          rows.push(current);
          current = [];
          value = '';
        } else {
          value += char;
        }
      }

      if (value.length || current.length) {
        current.push(value);
        rows.push(current);
      }

      return rows.filter((row) => row.length && !(row.length === 1 && row[0] === ''));
    }

    function importCsv(text) {
      const rows = parseCsv(text);
      if (!rows.length) return;
      const [header, ...dataRows] = rows;
      const indices = {
        id: header.indexOf('id'),
        title: header.indexOf('title'),
        tags: header.indexOf('tags'),
        note: header.indexOf('note'),
        state: header.indexOf('state'),
        created: header.indexOf('created'),
        dueDate: header.indexOf('end date'),
        project: header.indexOf('project'),
        importance: header.indexOf('importance'),
      };

      const required = ['id', 'title', 'tags', 'note', 'state', 'created', 'project', 'importance'];
      const missingRequired = required.some((key) => indices[key] === -1);
      if (missingRequired) {
        alert('El CSV no contiene el formato esperado.');
        return;
      }

      const imported = dataRows
        .map((row) => {
          const id = row[indices.id]?.trim();
          const title = row[indices.title]?.trim() || 'Sin t√≠tulo';
          const tagsRaw = row[indices.tags] ?? '';
          const note = row[indices.note] ?? '';
          const state = row[indices.state]?.trim();
          const created = row[indices.created]?.trim();
          const project = row[indices.project]?.trim() || 'General';
          const importance = row[indices.importance]?.trim() || 'Media';
          const dueDate = indices.dueDate !== -1 ? row[indices.dueDate]?.trim() ?? '' : '';

          if (!id || !columnOrder.includes(state)) {
            return null;
          }

          return normalizeTask({
            id,
            title,
            tags: tagsRaw ? tagsRaw.split('|').map((tag) => tag.trim()).filter(Boolean) : [],
            note,
            state,
            created,
            project,
            importance,
            dueDate,
          });
        })
        .filter(Boolean);

      tasks = imported;
      saveState();
      renderProjectFilterOptions();
      renderBoard();
    }

    function renderProjectFilterOptions() {
      const previous = projectFilter.value;
      const uniqueProjects = new Set(tasks.map((task) => task.project));
      projectFilter.innerHTML = '<option value="all">Todos</option>';
      uniqueProjects.forEach((project) => {
        const option = document.createElement('option');
        option.value = project;
        option.textContent = project;
        projectFilter.appendChild(option);
      });
      if ([...uniqueProjects, 'all'].includes(previous)) {
        projectFilter.value = previous;
        filters.project = projectFilter.value;
      } else {
        projectFilter.value = 'all';
        filters.project = 'all';
      }
    }

    exportBtn.addEventListener('click', () => {
      if (!tasks.length) {
        alert('No hay tareas para exportar.');
        return;
      }
      downloadCsv();
    });

    importBtn.addEventListener('click', () => {
      fileInput.click();
    });

    fileInput.addEventListener('change', (event) => {
      const file = event.target.files?.[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        const text = e.target?.result;
        if (typeof text === 'string') {
          importCsv(text);
        }
      };
      reader.onerror = () => {
        alert('No fue posible leer el archivo.');
      };
      reader.readAsText(file, 'utf-8');
      fileInput.value = '';
    });

    clearBtn.addEventListener('click', () => {
      const confirmed = confirm('¬øSeguro que quieres borrar todas las tareas? Esta acci√≥n no se puede deshacer.');
      if (!confirmed) return;
      tasks = [];
      saveState();
      renderProjectFilterOptions();
      renderBoard();
    });

    projectFilter.addEventListener('change', () => {
      filters.project = projectFilter.value;
      renderBoard();
    });

    dateFilter.addEventListener('change', () => {
      filters.date = dateFilter.value;
      renderBoard();
    });

    boardColumns.forEach((column) => {
      column.addEventListener('dragover', (event) => {
        event.preventDefault();
        column.classList.add('drag-over');
      });

      column.addEventListener('dragleave', () => {
        column.classList.remove('drag-over');
      });

      column.addEventListener('drop', (event) => {
        event.preventDefault();
        column.classList.remove('drag-over');
        const id = event.dataTransfer.getData('text/plain');
        const state = column.dataset.state;
        if (!id || !state) return;
        const task = tasks.find((item) => item.id === id);
        if (!task) return;
        task.state = state;
        saveState();
        renderBoard();
      });
    });

    loadState();
    renderProjectFilterOptions();
    renderBoard();

    // Pomodoro timer
    const pomodoroDisplay = document.getElementById('pomodoro-display');
    const startBtn = document.getElementById('pomodoro-start');
    const pauseBtn = document.getElementById('pomodoro-pause');
    const resetBtn = document.getElementById('pomodoro-reset');

    const POMODORO_DURATION = 25 * 60;
    let remainingSeconds = POMODORO_DURATION;
    let timerInterval = null;

    function formatTime(seconds) {
      const mins = String(Math.floor(seconds / 60)).padStart(2, '0');
      const secs = String(seconds % 60).padStart(2, '0');
      return `${mins}:${secs}`;
    }

    function updatePomodoroDisplay() {
      pomodoroDisplay.textContent = formatTime(remainingSeconds);
    }

    function tick() {
      if (remainingSeconds <= 0) {
        clearInterval(timerInterval);
        timerInterval = null;
        remainingSeconds = 0;
        updatePomodoroDisplay();
        alert('¬°Pomodoro completado! T√≥mate un descanso.');
        return;
      }
      remainingSeconds -= 1;
      updatePomodoroDisplay();
    }

    function startTimer() {
      if (timerInterval) return;
      if (remainingSeconds <= 0) {
        remainingSeconds = POMODORO_DURATION;
      }
      timerInterval = setInterval(tick, 1000);
    }

    function pauseTimer() {
      if (!timerInterval) return;
      clearInterval(timerInterval);
      timerInterval = null;
    }

    function resetTimer() {
      pauseTimer();
      remainingSeconds = POMODORO_DURATION;
      updatePomodoroDisplay();
    }

    startBtn.addEventListener('click', startTimer);
    pauseBtn.addEventListener('click', pauseTimer);
    resetBtn.addEventListener('click', resetTimer);

    updatePomodoroDisplay();
  </script>
</body>
</html>
